<!DOCTYPE html>
<html>
<head>
  <title>Foroom</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="container">
    <h2>Forum Posts</h2>
    <div id="user"></div>
    <div id="posts"></div>
    <div id="msg"></div>
    <a href="signup.html">Sign up</a> | <a href="login.html">Login</a>
    <a href="users.html">View all users</a>
    <div id="newpost" style="display:none;">
      <h3>New Post</h3>
      <form onsubmit="return createPost()">
        <input id="title" placeholder="Title" required /><br>
        <textarea id="content" placeholder="Content" required></textarea><br>
        <button type="submit">Post</button>
      </form>
    </div>
  </div>
  <script src="js/api.js"></script>
  <script>
    function showPosts() {
      api("/posts").then(posts => {
        posts = posts || [];
        document.getElementById("posts").innerHTML =
          posts.map(p => `
            <div>
              <b>${p.title}</b> by ${p.author} <br>
              <a href="post.html?id=${p.id}">Read / Reply</a>
            </div>
          `).join("<hr>");
      });
    }
    function showUser() {
      if (isLoggedIn()) {
        document.getElementById("user").innerHTML =
          `<b>Logged in as ${JSON.parse(atob(getToken().split('.')[1])).username}</b>
           <button onclick="logout()">Logout</button>`;
        document.getElementById("newpost").style.display = "";
      }
    }
    function createPost() {
      api("/posts", "POST", {title: title.value, content: content.value})
        .then(res => {
          if (res.ok) { showPosts(); title.value = ""; content.value = ""; }
          else if (res.error) { document.getElementById("msg").innerText = res.error; }
        });
      return false;
    }
    function logout() { clearToken(); location.reload(); }
    showPosts(); showUser();
  </script>
</body>
</html>
